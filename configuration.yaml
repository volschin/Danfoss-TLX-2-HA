# =============================================================================

# Danfoss TLX Pro - Home Assistant Konfiguration

# =============================================================================

# EtherLynx-Integration (UDP, kein ESP32/RS485 nÃ¶tig!)

# 

# VARIANTE A: MQTT-Sensoren (empfohlen)

# â†’ Starte danfoss_ha_bridge.py â€“mode mqtt als Daemon

# â†’ HA erkennt Sensoren automatisch via MQTT Discovery

# â†’ Keine manuelle Sensor-Konfiguration nÃ¶tig!

# 

# VARIANTE B: Command-Line-Sensoren (einfacher, kein MQTT nÃ¶tig)

# â†’ HA ruft das Script direkt auf und liest JSON

# â†’ Konfiguration unten in configuration.yaml einfÃ¼gen

# 

# WÃ¤hle EINE Variante. Variante A wird empfohlen.

# =============================================================================

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

# â•‘  VARIANTE A: MQTT (empfohlen)                                           â•‘

# â•‘  â†’ Sensoren werden automatisch per MQTT Discovery angelegt              â•‘

# â•‘  â†’ Nur MQTT-Broker muss konfiguriert sein                               â•‘

# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# MQTT Broker muss in HA eingerichtet sein (z.B. Mosquitto Add-on)

# Dann nur den Daemon starten - keine Sensor-Konfiguration nÃ¶tig!

# 

# Daemon starten:

# python3 /config/scripts/danfoss_ha_bridge.py \

# â€“mode mqtt \

# â€“ip 192.168.1.100 \

# â€“mqtt-host localhost

# 

# Als systemd-Service:

# Siehe danfoss_etherlynx.service

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

# â•‘  VARIANTE B: Command-Line-Sensoren                                      â•‘

# â•‘  â†’ Kein MQTT nÃ¶tig                                                       â•‘

# â•‘  â†’ HA ruft Script direkt auf                                             â•‘

# â•‘  â†’ Weniger AbhÃ¤ngigkeiten                                                â•‘

# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

command_line:

# â”€â”€ Echtzeit-Sensor (alle 30 Sekunden) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- sensor:
  name: â€œDanfoss TLX Realtimeâ€
  unique_id: danfoss_tlx_realtime
  command: >-
  python3 /config/scripts/danfoss_ha_bridge.py
  â€“ip 192.168.1.100
  â€“mode realtime
  scan_interval: 30
  command_timeout: 10
  json_attributes:
  - grid_power_total
  - grid_power_l1
  - grid_power_l2
  - grid_power_l3
  - pv_voltage_1
  - pv_voltage_2
  - pv_current_1
  - pv_current_2
  - pv_power_1
  - pv_power_2
  - grid_voltage_l1
  - grid_voltage_l2
  - grid_voltage_l3
  - grid_current_l1
  - grid_current_l2
  - grid_current_l3
  - grid_frequency_avg
  - grid_energy_today_total
  - operation_mode
  - operation_mode_text
  - status
  value_template: â€œ{{ value_json.grid_power_total | default(0) }}â€
  unit_of_measurement: â€œWâ€
  device_class: power
  state_class: measurement

# â”€â”€ Energie-Sensor (alle 5 Minuten) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- sensor:
  name: â€œDanfoss TLX Energyâ€
  unique_id: danfoss_tlx_energy
  command: >-
  python3 /config/scripts/danfoss_ha_bridge.py
  â€“ip 192.168.1.100
  â€“mode energy
  scan_interval: 300
  command_timeout: 15
  json_attributes:
  - total_energy
  - energy_today
  - grid_energy_today_total
  - grid_energy_today_l1
  - grid_energy_today_l2
  - grid_energy_today_l3
  - pv_energy_1
  - pv_energy_2
  - production_today_log
  - production_this_week
  - production_this_month
  - production_this_year
  - status
  value_template: â€œ{{ value_json.total_energy | default(0) }}â€
  unit_of_measurement: â€œWhâ€
  device_class: energy
  state_class: total_increasing

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

# â•‘  Template-Sensoren (fÃ¼r beide Varianten nutzbar)                         â•‘

# â•‘  â†’ Extrahieren einzelne Werte aus den JSON-Attributen                    â•‘

# â•‘  â†’ Berechnen abgeleitete Werte (Effizienz, DC-Leistung)                 â•‘

# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

template:

- sensor:
  
  # â”€â”€ Aktuelle Leistung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Leistung Gesamtâ€
    unique_id: tlx_power_total
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_power_totalâ€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
    icon: mdi:solar-power-variant
  - name: â€œTLX Leistung L1â€
    unique_id: tlx_power_l1
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_power_l1â€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
  - name: â€œTLX Leistung L2â€
    unique_id: tlx_power_l2
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_power_l2â€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
  - name: â€œTLX Leistung L3â€
    unique_id: tlx_power_l3
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_power_l3â€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
  
  # â”€â”€ PV-Strings (DC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX PV Spannung String 1â€
    unique_id: tlx_pv_v1
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_voltage_1â€™) | default(0) | float }}
    unit_of_measurement: â€œVâ€
    device_class: voltage
    state_class: measurement
  - name: â€œTLX PV Spannung String 2â€
    unique_id: tlx_pv_v2
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_voltage_2â€™) | default(0) | float }}
    unit_of_measurement: â€œVâ€
    device_class: voltage
    state_class: measurement
  - name: â€œTLX PV Strom String 1â€
    unique_id: tlx_pv_a1
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_current_1â€™) | default(0) | float }}
    unit_of_measurement: â€œAâ€
    device_class: current
    state_class: measurement
  - name: â€œTLX PV Strom String 2â€
    unique_id: tlx_pv_a2
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_current_2â€™) | default(0) | float }}
    unit_of_measurement: â€œAâ€
    device_class: current
    state_class: measurement
  - name: â€œTLX PV Leistung String 1â€
    unique_id: tlx_pv_w1
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_1â€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
  - name: â€œTLX PV Leistung String 2â€
    unique_id: tlx_pv_w2
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_2â€™) | default(0) | float }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
  
  # â”€â”€ DC Gesamtleistung (berechnet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX DC Leistung Gesamtâ€
    unique_id: tlx_dc_power_total
    state: >-
    {% set p1 = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_1â€™) | default(0) | float %}
    {% set p2 = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_2â€™) | default(0) | float %}
    {{ (p1 + p2) | round(0) }}
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
    icon: mdi:solar-panel-large
  
  # â”€â”€ Wirkungsgrad (berechnet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Wirkungsgradâ€
    unique_id: tlx_efficiency
    state: >-
    {% set ac = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_power_totalâ€™) | default(0) | float %}
    {% set p1 = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_1â€™) | default(0) | float %}
    {% set p2 = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜pv_power_2â€™) | default(0) | float %}
    {% set dc = p1 + p2 %}
    {% if dc > 50 %}
    {{ ((ac / dc) * 100) | round(1) }}
    {% else %}
    0
    {% endif %}
    unit_of_measurement: â€œ%â€
    icon: mdi:percent
    state_class: measurement
  
  # â”€â”€ Netzspannungen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Netzspannung L1â€
    unique_id: tlx_grid_v_l1
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_voltage_l1â€™) | default(0) | float }}
    unit_of_measurement: â€œVâ€
    device_class: voltage
    state_class: measurement
  - name: â€œTLX Netzspannung L2â€
    unique_id: tlx_grid_v_l2
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_voltage_l2â€™) | default(0) | float }}
    unit_of_measurement: â€œVâ€
    device_class: voltage
    state_class: measurement
  - name: â€œTLX Netzspannung L3â€
    unique_id: tlx_grid_v_l3
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_voltage_l3â€™) | default(0) | float }}
    unit_of_measurement: â€œVâ€
    device_class: voltage
    state_class: measurement
  
  # â”€â”€ Netzfrequenz â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Netzfrequenzâ€
    unique_id: tlx_grid_frequency
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_frequency_avgâ€™) | default(0) | float }}
    unit_of_measurement: â€œHzâ€
    device_class: frequency
    state_class: measurement
  
  # â”€â”€ Betriebsmodus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Betriebsmodusâ€
    unique_id: tlx_operation_mode
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜operation_mode_textâ€™) | default(â€˜Unbekanntâ€™) }}
    icon: mdi:information-outline
  
  # â”€â”€ Online-Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Onlineâ€
    unique_id: tlx_online
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜statusâ€™) | default(â€˜offlineâ€™) }}
    icon: >-
    {% if is_state(â€˜sensor.tlx_onlineâ€™, â€˜onlineâ€™) %}
    mdi:check-network
    {% else %}
    mdi:close-network
    {% endif %}
  
  # â”€â”€ Energie-Werte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: â€œTLX Gesamtproduktionâ€
    unique_id: tlx_total_energy
    state: >-
    {% set wh = state_attr(â€˜sensor.danfoss_tlx_energyâ€™, â€˜total_energyâ€™) | default(0) | float %}
    {{ (wh / 1000) | round(1) }}
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing
    icon: mdi:counter
  - name: â€œTLX Produktion heuteâ€
    unique_id: tlx_energy_today
    state: >-
    {% set wh = state_attr(â€˜sensor.danfoss_tlx_realtimeâ€™, â€˜grid_energy_today_totalâ€™) | default(0) | float %}
    {{ (wh / 1000) | round(2) }}
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing
    icon: mdi:white-balance-sunny
  - name: â€œTLX Produktion diese Wocheâ€
    unique_id: tlx_energy_week
    state: >-
    {% set wh = state_attr(â€˜sensor.danfoss_tlx_energyâ€™, â€˜production_this_weekâ€™) | default(0) | float %}
    {{ (wh / 1000) | round(1) }}
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing
  - name: â€œTLX Produktion diesen Monatâ€
    unique_id: tlx_energy_month
    state: >-
    {% set wh = state_attr(â€˜sensor.danfoss_tlx_energyâ€™, â€˜production_this_monthâ€™) | default(0) | float %}
    {{ (wh / 1000) | round(1) }}
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing
  - name: â€œTLX Produktion dieses Jahrâ€
    unique_id: tlx_energy_year
    state: >-
    {{ state_attr(â€˜sensor.danfoss_tlx_energyâ€™, â€˜production_this_yearâ€™) | default(0) | float | round(0) }}
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

# â•‘  Automations                                                             â•‘

# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:

# â”€â”€ Fehler-Benachrichtigung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- alias: â€œDanfoss TLX Fehlermeldungâ€
  id: danfoss_tlx_error
  trigger:
  - platform: state
    entity_id: sensor.tlx_betriebsmodus
    to: â€œStÃ¶rungâ€
  - platform: state
    entity_id: sensor.tlx_betriebsmodus
    to: â€œNetzfehlerâ€
    action:
  - service: persistent_notification.create
    data:
    title: â€œâš ï¸ Danfoss TLX Pro Warnungâ€
    message: >-
    Der Wechselrichter meldet: {{ states(â€˜sensor.tlx_betriebsmodusâ€™) }}
    Zeitpunkt: {{ now().strftime(â€™%d.%m.%Y %H:%Mâ€™) }}

# â”€â”€ Tagesproduktions-Bericht (21:00 Uhr) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- alias: â€œDanfoss TLX Tagesberichtâ€
  id: danfoss_tlx_daily_report
  trigger:
  - platform: time
    at: â€œ21:00:00â€
    action:
  - service: persistent_notification.create
    data:
    title: â€œâ˜€ï¸ Solar-Tagesberichtâ€
    message: >-
    Produktion heute: {{ states(â€˜sensor.tlx_produktion_heuteâ€™) }} kWh
    Gesamtproduktion: {{ states(â€˜sensor.tlx_gesamtproduktionâ€™) }} kWh
    Max. Leistung heute: wird von HA im Energy-Dashboard erfasst

# â”€â”€ Hohe Produktion (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- alias: â€œDanfoss TLX Hohe Produktionâ€
  id: danfoss_tlx_high_production
  trigger:
  - platform: numeric_state
    entity_id: sensor.tlx_produktion_heute
    above: 30
    action:
  - service: persistent_notification.create
    data:
    title: â€œğŸ‰ Super Solartag!â€
    message: >-
    Schon {{ states(â€˜sensor.tlx_produktion_heuteâ€™) }} kWh heute produziert!

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

# â•‘  Energy Dashboard                                                        â•‘

# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# FÃ¼r das HA Energy Dashboard verwende diesen Sensor:

# â†’ Solar-Produktion: sensor.tlx_produktion_heute (oder sensor.tlx_gesamtproduktion)

# 

# Bei MQTT-Variante (Variante A): Der entsprechende Sensor heiÃŸt

# sensor.danfoss_tlx_<serial>_grid_energy_today_total
